# スコープと名前空間

ソースコード上の識別子 `foo` や `foo@` の出現が何を指しているかを判断したい。

ここでは次のように用語を定めて使う。

- 修飾: `@` がついている識別子は修飾されているといい、そういう識別子を修飾名と呼ぶ。
    - 逆に `@` がついていない識別子は非修飾名という。
    - ここでは `@` の前の部分をbasenameという。
    - `@` の後ろの部分は名前空間の名前になっている。
        - 特に、`@` の後ろに何もない場合は、名前が空の名前空間 (トップレベル名前空間) を指している。
- 環境: 名前から定義への対応づけ。
- スコープ: 名前が使用可能な範囲を表現するもの。
    - スコープは環境を持つ。
    - スコープ同士には親子関係があり、スコープ全体はツリーをなす。
        すべてのスコープの根としてglobalスコープがある。
    - スコープから名前を探すとき、そのスコープの環境に名前が見つからなかったら、親スコープからも探す (スコープチェイン)。
- 名前空間: 名前の階層構造を表現するもの。
    - 名前空間はそれ自身の名前と、環境を持つ。
    - HSP3の名前空間に親子関係はない。

## トップレベル名前空間

名前が空の名前空間を、ここではトップレベル名前空間と呼ぶ。

- トップレベルで定義される変数やラベルはトップレベル名前空間に属す。トップレベルのglobalでないマクロもトップレベル名前空間に属す。

## hsp3名前空間

ほとんどの組み込みの命令や関数は `hsp3` 名前空間に属す。
(例えば `mes` は `mes@hsp3` と同じ。)

## globalスコープ

`#deffunc` や `#define global` で定義される名前はglobalスコープに属す。トップレベル名前空間にも属す。

## モジュールのスコープ

`#module`-`#global` で囲まれている範囲はモジュールの内部であり、それ以外の部分はモジュールの外部である。
ここではモジュールの外部をトップレベルと呼ぶ。
モジュールは入れ子にならない。
モジュールの内部では、そのモジュールが作るスコープになっている。
このスコープの親はglobalスコープである。(モジュールの外部のスコープは、モジュールの内部のスコープの祖先にならない。)

## deffuncのスコープ

`#deffunc` 系の命令から、そのdeffuncが作る新しいスコープが始まる。
このスコープは、同じモジュールにおいて次にdeffunc系の命令が出現する直前まで続く。
(deffunc系の命令には deffunc, defcfunc, modfunc, modcfunc, modinit, modterm が含まれる。)
(deffuncが作るスコープにはパラメータだけが属す。)

## defineのスコープ

TODO

## 名前を定義するときのスコープと名前空間

名前を定義するときは以下の要素を考慮する:

- 定義される名前が修飾されているか否か
- globalに定義するか、localに定義するか
    (`#deffunc` や `#define global` などはglobalに定義する。それ以外はlocalに定義する。)
- 名前を巻き上げるか否か
    (`#define`, `#const`, `#enum` が定義する名前は巻き上げない。それ以外は巻き上げる。)

どのスコープ・名前空間に属すかは、次のように決める:

- 定義される名前が修飾されていないとき:
    - globalに定義されるなら、その名前はglobalスコープとトップレベル名前空間に属す。
    - localに定義されるなら、その名前は定義箇所のスコープに属し、定義箇所のモジュールと同名の名前空間に属す。
        - モジュールの外部なら、代わりにトップレベル名前空間に属す。匿名のモジュールの内部なら、名前空間には属さない。
- 定義される名前が修飾されていて、トップレベル名前空間を指すとき:
    - globalに定義されるなら、その名前はglobalスコープとトップレベル名前空間に属す。
    - localに定義されるなら、その名前は定義箇所のスコープに属し、定義箇所のモジュールと同名の名前空間に属す。
        - モジュールの外部なら、代わりにトップレベル名前空間に属す。匿名のモジュールの内部なら、名前空間には属さない。

## 名前をundefするときのスコープ

(`#undef` は名前空間には影響しない。)

TODO

## 名前を参照するときのスコープと名前空間

- 参照される名前が修飾されていないとき:
    - 使用箇所のモジュールの名前空間から探す。
    - 見つからなければ、globalスコープから探す。
- 参照される名前が修飾されているとき:
    - 修飾されている名前空間から探す。
    - 修飾されている名前空間がトップレベル名前空間なら、globalスコープからも探す。

## 備考

- 名前空間とスコープは何が違うか:
    - 名前空間は名前を持つが、スコープは名前を持たない。
    - 名前空間は修飾名を解決するときに使う。
        スコープは基本的に、非修飾名を解決するときに使う。
    - 名前空間に属す名前は、修飾名によっていつでも参照できる。
        スコープは基本的に、スコープの外側からは参照されない。
    - スコープは親子関係があり、スコープから名前を探すときは、見つからなければ親スコープからも探す。
        名前空間が階層構造を持つ言語とは違って、HSP3では名前空間から名前が見つからなくても「親の名前空間」に遡って探すという挙動はしない。
