# アーキテクチャ

(WIP)

(**HAM** は `hsp3-analyzer-mini` 自身のこと)

これは「HAMのコードベースへの理解」を助けることを目的として書かれている

## 前提知識

- HSP、HAMの基本的な使いかた
- インタプリタまたはコンパイラの基本的な仕組み、作りかた
- ほか

## アナライザ

- HAMのようなソフトウェアを **アナライザ** (analyzer) と呼ぶことにする
- アナライザは言語処理系の一種で、エディタ内でのホバー表示や入力補完などの機能を提供するソフトウェアである
- アナライザが提供するそれらの機能を総称的に **IDE機能** と呼ぶことにする

### アナライザの入出力

- アナライザは **入力** としてスクリプトと、そのスクリプトの意味に関する質問を受け取り、質問への回答を **出力** するものである
- 例:
    - ホバー表示でいえば、質問は「`main.hsp` の8行目・4文字目にある `foo` という単語は何？」といったもの
    - アナライザは「この `foo` はdeffuncで定義された命令である」と応答できる
- アナライザはスクリプトに関する問い合わせシステムであるといえる

### LSP

- **LSP** (language server protocol) はエディタ (VSCode) とアナライザをつなぐための仕組み
- ユーザーの操作によって、エディタはIDE機能を作動させる。エディタはその処理のためにアナライザに問い合わせを行う
    - (エディタにプログラミング言語固有の機能を持たせるわけにはいかないため)
- LSPという仕様では、エディタがアナライザにどう問い合わせるか、アナライザがそれにどう応答するか、を定められている

----

## HAMの内部構造

- HAMの内部構造は大きく分けて以下のパーツからなる
    - 字句解析・構文解析
    - 意味解析
    - データベースレイヤー
    - IDE機能
    - LSPサーバー

### 字句解析・構文解析

- (ここはインタプリタやコンパイラと同様)
- スクリプトを **字句解析** (tokenize) してトークン列 (tokens) に変換する
- トークン列を **構文解析** (parse) して **解析木** (parse tree) に変換する
- IDE機能に使うため、位置情報 (location) を正確に保持している

### 意味解析

- (ここはインタプリタやコンパイラと同様)
- 解析木に **意味解析** を行い、**シンボル** (symbol) や **スコープ** (scope) の情報を収集する
    - **シンボル** (symbol) はスクリプト内で定義されている名前のこと (変数やラベル、命令など)

### データベースレイヤー

- (これは仮の呼称。このパーツのことを何と呼ぶべきか分からない)
- HAMは実行中に以下の2つのデータを保持している
- 1つ目:
    - HAMが扱うスクリプトは、ファイルに保存されているものと、エディタ内で編集中のものがある。これらを総称して **ドキュメント** (document) と呼ぶ
    - HAMは全ドキュメントのデータを保持している
        - ファイルの内容を保持しているのは、ファイルの読み込みにかかる時間を省くため
        - 「エディタ内の編集中のデータ」は、アナライザから問い合わせて取得することができず、エディタから送られてくるものであるため
- 2つ目:
    - 解析結果を表すデータ構造を **アナリシス** (analysis) と呼んでいる
    - HAMは意味解析の結果の一部をキャッシュとして保持している。これは効率を改善するため
- 効率の話:
    - エディタ上でキー入力されるたびに、スクリプトの変更とIDE機能の処理要求が発生する。これはかなりの高頻度である
    - 一連の解析処理を毎回、最初から行うのは非効率である。たいていの場合、スクリプトの変更は1行の追加や削除で、解析処理の大部分は変化しないため
    - 解析処理の結果を記憶 (キャッシュ) しておき、変更の影響を受けなかった部分の再解析をある程度防ぐように、データ構造が設計されている

### IDE機能

- アナリシスを使って、ホバー表示や入力補完などの個別のIDE機能が実装されている

### LSPサーバー

- **LSPサーバー** (LSP server) は、LSP仕様にしたがって動作するプロセスで、エディタとアナライザが対話するためのもの

----

> [ARCHITECTURE.md](https://matklad.github.io/2021/02/06/ARCHITECTURE.md.html)
