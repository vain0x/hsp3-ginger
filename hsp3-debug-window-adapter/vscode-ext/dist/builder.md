# Builder

このファイルは `builder.hsp` の説明です。
(エンコーディングの問題を防ぐため、builder.hspには日本語を書かないようにしています。)

ビルダー (builder) は、HSP3のスクリプトをコンパイルするための最小限のツールです。
オブジェクトファイルの作成と実行ファイルの作成ができます。

## 使いかた

凡例:

```bat
    builder.exe <サブコマンド> --hsp <インストールディレクトリ> [OPTIONS...] <スクリプトファイル>
```

使用例:

```bat
    builder.exe compile --hsp "C:/hsp37" --out hello.ax hello.hsp
```

```bat
    builder.exe make --hsp "C:/hsp37" hello.hsp
```

コマンドライン引数の先頭にはサブコマンドを指定します。サブコマンドは以下のいずれかです:

- `compile`: スクリプトをコンパイルしてオブジェクトファイルを作る
- `make`: スクリプトをコンパイルして実行ファイルを作る
- `help`: ヘルプ表示
- `version`: バージョン表示

### `compile` サブコマンド

`compile` サブコマンドはオブジェクトファイルを生成します。

コンパイルに成功すると、指定したスクリプトと同じディレクトリに `start.ax` という名前でオブジェクトファイルが生成されます。
標準出力にコンパイラからのメッセージを書き込みます。
それに加えて、使用されるランタイムを以下のような構文で表示します。

```
#Use runtime "C:/hsp37/hsp3.exe"
```

コンパイルに失敗した場合は、エラーメッセージを標準出力に書き、コード1で終了します。

### `make` サブコマンド

(*この機能は使っていません*)

`make` サブコマンドは実行ファイルを生成します。

処理に成功すると、指定したスクリプトと同じディレクトリに実行ファイルが生成されます。
ファイル名は、スクリプトファイルの名前の拡張子を `.exe` に変えたもの (例えば `hello.hsp` → `hello.exe`) です。
ただし、スクリプトが `#packopt name` でファイル名を指定している場合、その名前になります。

処理に失敗した場合は、エラーメッセージを標準出力に書き、コード1で終了します。

### `--hsp` オプション (必須)

```
    --hsp <インストールディレクトリ>
```

`--hsp` オプションに、HSP3のインストールディレクトリへの絶対パスを指定してください。

このオプションはサブコマンド `compile`, `make` の両方で必須です。

### `--utf8-input` フラグ (省略可)

`--utf8-input` フラグを指定すると、コンパイルされるスクリプトのエンコーディングをUTF-8だとみなします。

このフラグはすべてのサブコマンドで省略可能です。省略時は、エンコーディングをshift_jisだとみなします。

具体的には `hsc_comp` 命令の第2引数に影響します。
既定ではフラグ32を指定しません。
`--utf8-input` フラグが指定されているときは、フラグ32を指定します。
(なお、標準のスクリプトエディタはフラグ32を指定しません。)

このフラグが指定されていて、`--utf8-output` フラグが指定されていない場合、スクリプトに書かれている文字列などのデータはshift_jisに変換されます。

### `--utf8-output` フラグ (省略可)

`--utf8-output` フラグを指定すると、コンパイルの結果であるオブジェクトファイルや実行ファイルに書き込まれるデータのエンコーディングが、UTF-8になります。

このフラグはすべてのサブコマンドで省略可能です。省略時は、データのエンコーディングはshift_jisになります。

具体的には `hsc_comp` 命令の第1引数に影響します。
既定ではフラグ4を指定しませんが、`--utf8-output` フラグが指定されているときは、フラグ4を指定します。
(なお、標準のスクリプトエディタはフラグ4を指定しません。)

このフラグが指定されていて、`--utf8-input` フラグが指定されていない場合、スクリプトに書かれている文字列などのデータはUTF-8に変換されます。

## ビルダーのビルド手順

ビルダーを使ってスクリプトを実行する手順を説明します。

----

*ステップ1*: 事前準備として、ビルダーをコンパイルします。

HSP3のインストールディレクトリに `hspcmp.exe` というツールがあり、スクリプトのオブジェクトファイルを作成できます。

例:

```bat
    C:\hsp37\hspcmp.exe "--compath=C:\hsp37\common\" "C:/path/to/builder.hsp"
```

HSP3のインストールディレクトリへの絶対パスを仮に `C:\hsp37` だとします。
引数に以下の2つを指定して、`hspcmp.exe` を実行します:

- `--compath=絶対パス\` という構文で、commonディレクトリへの絶対パスを指定します。(末尾のバックスラッシュは必須)
- `builder.hsp` への絶対パスを指定します

これによりビルダーのオブジェクトファイル (`builder.ax`) が生成されます。

----

*ステップ2*: ビルダーを使って、入力されるスクリプトをコンパイルします。

入力されるスクリプトへの絶対パスを仮に `C:/path/to/main.hsp` だとします。

コマンドライン版のHSP3のランタイム `hsp3cl.exe` にビルダーのオブジェクトファイルを渡すことで、ビルダーを実行できます。
その引数として入力されるスクリプトを指定します。

```bat
    C:\hsp37\hsp3cl.exe "C:/path/to/builder.ax" compile --hsp "C:\hsp37\" "C:/path/to/main.hsp"
```

これによりオブジェクトファイル (`C:/path/to/main.ax`) が生成されます。
また、標準出力にランタイムの名前が書かれるので、それを読み取ります。

なおコンパイルに失敗した場合は、標準出力にエラーメッセージが書かれます。

----

*ステップ3*: ランタイムを使って、オブジェクトファイルを実行します。

----
----

## その他

- `hspcmp.dll` の解説も参照してください

### ビルダーと `hspcmp.exe` の違い

`hspcmp.exe` はコンパイルしたスクリプトを実行するためにどのランタイムを使えばよいのかを出力しません。使うランタイムが事前に分かっているスクリプトをコンパイルするときだけ使えます
